# Final LAB Trainning


## Introduction:


There are trhee enviroments, tow of them mus be generates by the RedHat lab web https://labs.opentlc.com/

    -- Ansible Advanced - Homework (Tower)
	   -- Ansible Advanced NG - OpenStack (QA: Openstack)

The third enviroment is generated by a playbook in the workfow :

     -- Ansible Advanced - Three Tier App (PRO: AWS)

## Pre requirements:

Be sure that you have been configures your SSH key on https://labs.opentlc.com/

Copy your OPENTLC private key to the Ansible Advanced - Homework control host under the root user’s home directory.

The path to your OPENTLC key is /root/.ssh/mykey.pem.

Set the permissions of the /root/.ssh/mykey.pem file to 0400 and set the owner as root:root.

You need toSet Up Control host 

      export TOWER_GUID=<Tower env GUID>
      export OSP_GUID=<OSP Env GUID>
      export OSP_DOMAIN=<OSP Env domain name>
      export OPENTLC_ID=<username-example.com>
      export MAIL_ID=<username@example.com>
      export OPENTLC_PASSWORD=<Your OPENTLC Password>
      export GITHUB_REPO=https://github.com/<github username>/nextgen_ansible_advanced_homework.git
      export JQ_REPO_BASE=http://www.opentlc.com/download/ansible_bootcamp
      export REGION=us-east-1

Run the site-setup-prereqs.yaml playbook to provision the network, flavor, security groups, and SSH keys:

        [root@control ~/nextgen_ansible_advanced_homework]# mv ~/ansible-tower-setup-*/ ~/ansible-tower-setup-latest
        [root@control ~/nextgen_ansible_advanced_homework]# cp /etc/ansible/hosts ~/ansible-tower-setup-latest/inventory
        [root@control ~/nextgen_ansible_advanced_homework]# chmod 0400 /root/.ssh/openstack.pem
        [root@control ~/nextgen_ansible_advanced_homework]# ansible-playbook site-setup-prereqs.yaml -k
        Password:<copy your OSP workstation password from email>

The playbook sets up openstack.pem as a private key and openstack.pub as a public key for connecting to the workstation host from the control host.

The playbook also sets up workstation-${OSP_GUID}.${OSP_DOMAIN} as an isolated node.

Verify a successful connection between the control and workstation hosts using the openstack.pem key:

      [root@control ~/nextgen_ansible_advanced_homework]# ssh -i /root/.ssh/openstack.pem cloud-user@workstation-${OSP_GUID}.${OSP_DOMAIN}
      [cloud-user@workstation ~]$ exit
      
From your web browser, connect to tower1.${TOWER_GUID}.example.opentlc.com to verify that the isolated node is operational, using admin for the username and password As provided in email.


## Review Tower configuration:

### Templates :

         -- 01_Provision Prod Env 
         -- 02_Provision QA Env
         -- 04_3tier app deployment on QA Env 
         -- 05_Smoke test QA Env 
         -- 07_Prod Check the status of AWS instances 
         -- 09_3 tier app on Prod 
         -- 10_Smoke test Prod env
         -- cicd_workflow
         -- Demo Job Template
         -- Plantilla de trabajo
         -- Nuke QA Env
         -- Plantilla de trabajo

### Credencials

.List of Credencials
[%header,cols=2*]
|===
| Credential name           | Type                        
| AWS Access                | Key Amazon Web Services    
| Connect_to_workstation    | Machine                     
| Creds for AWS instances   | Machine                    
| Demo Credential           | Machine                    
| Opentlc key               | Machinee                   
| Opentlc key test *        | Machine                     
| yum-repo-cred             | Vault
|===

### Notes

Connection to prod bastion instance didn't work for my user, therefore step **08_Prod SSH keys three tier app** failed.
To overcome this, create a new credencial called Opentlc key test * and insert your bastion´s access password and re-run the workflow from failed step or from start.

## Inventories

  -- Demo Inventory
  -- Prod Three tier inventory
  -- scm_inventory

# Run the workfow

Run the workflow template from the Ansible Tower UI, which must be able to run successfully according to these requirements:

-- Provision instances in the OpenStack QA environment
-- Deploy the application in the QA environment
-- Run the smoke test to verify the application

Like there is an error with the SSH key , please revie Notes* you need to run the next templates direcly from Tower

-- Provision instances on AWS using order_svc.sh script for the production environment
-- Deploy the application in the production environment
-- Run the smoke test to verify the application

On the last one thre is a mistake because the playbook use the public IP to check the status that is frobidden, a workaround could be use the internal IP to test





==== Ansible Tower Config


* From the cloned repo run `site-config-tower.yml` playbook to create job templates and workflow template.



.List of Playbooks
[%header,cols=2*]
|===
| Files or dir | Purpose
| app-tier | Install application server role
| db-tier  | Install postgressql server for database role
| lb-tier  | Install HA proxy role
| base-config | Setup yum repo and base packages role
| setup-workstation | Setup workstation, create network, ssh keypair, security group etc. role 
| osp-servers | Provision OSP Instances role
| osp-instance-delete | Delete OSP Instances role
| osp-facts | Genrate in-memory inventory for OSP instances role
| roles/config-tower/vars/main.yml | Very important file to review. All the variable values are set there. Please do not make any changes in the file
| config-tower | Role to configure ansible tower job templates and workflow
| aws_creds.yml | Fetch GUIDkey.pem from bastion of Three tier application env and create machine credential to connect to AWS instances
| aws_provision.yml | Use `order_svc.sh` script to provision env
| aws_status_check.yml | Check aws instances are up or not
| site-3tier-app.yml | Playbook to deploy three tier app
| site-install-isolated-node.yml | Playbook to install isolated node
| site-config-tower.yml | Playbook to call role `config-tower`
| site-osp-delete.yml | Playbook to call role
| site-osp-instances.yml | Playbook to call role
| site-setup-prereqs.yml | Playbook to call role
| site-smoke-osp.yml | Playbook to test three tier app on OSP
| site-smoketest-aws.yml | Playbook to test three tier app on AWS
| grading-script.yml | Self grading script
| roles/config-tower/tasks/ec2_dynamic.yml | For creating Dynamic inventory in Ansible tower. Use `AWS Access Key` for credential
| roles/config-tower/tasks/job_template.yml | For creating job templates
| roles/config-tower/tasks/pre-config-tower.yml | Any pre config tasks needed
| roles/config-tower/tasks/workflow_template.yml | genrate workflow from `workflow.yml` file
| roles/config-tower/tasks/post-config-tower.yml | any post config jobs
|===
